{"version":3,"file":"fast-json-patch-es.min.js","sources":["../lib/duplex.js"],"sourcesContent":["Object.defineProperty(exports, \"__esModule\", { value: true });\n/*!\n * https://github.com/Starcounter-Jack/JSON-Patch\n * (c) 2017 Joachim Wester\n * MIT license\n */\nvar helpers_1 = require(\"./helpers\");\nvar core_1 = require(\"./core\");\n/* export all core functions */\nvar core_2 = require(\"./core\");\nexports.applyOperation = core_2.applyOperation;\nexports.applyPatch = core_2.applyPatch;\nexports.applyReducer = core_2.applyReducer;\nexports.getValueByPointer = core_2.getValueByPointer;\nexports.validate = core_2.validate;\nexports.validator = core_2.validator;\n/* export some helpers */\nvar helpers_2 = require(\"./helpers\");\nexports.JsonPatchError = helpers_2.PatchError;\nexports.deepClone = helpers_2._deepClone;\nexports.escapePathComponent = helpers_2.escapePathComponent;\nexports.unescapePathComponent = helpers_2.unescapePathComponent;\nvar beforeDict = new WeakMap();\nvar Mirror = /** @class */ (function () {\n    function Mirror(obj) {\n        this.observers = new Map();\n        this.obj = obj;\n    }\n    return Mirror;\n}());\nvar ObserverInfo = /** @class */ (function () {\n    function ObserverInfo(callback, observer) {\n        this.callback = callback;\n        this.observer = observer;\n    }\n    return ObserverInfo;\n}());\nfunction getMirror(obj) {\n    return beforeDict.get(obj);\n}\nfunction getObserverFromMirror(mirror, callback) {\n    return mirror.observers.get(callback);\n}\nfunction removeObserverFromMirror(mirror, observer) {\n    mirror.observers.delete(observer.callback);\n}\n/**\n * Detach an observer from an object\n */\nfunction unobserve(root, observer) {\n    observer.unobserve();\n}\nexports.unobserve = unobserve;\n/**\n * Observes changes made to an object, which can then be retrieved using generate\n */\nfunction observe(obj, callback) {\n    var patches = [];\n    var observer;\n    var mirror = getMirror(obj);\n    if (!mirror) {\n        mirror = new Mirror(obj);\n        beforeDict.set(obj, mirror);\n    }\n    else {\n        var observerInfo = getObserverFromMirror(mirror, callback);\n        observer = observerInfo && observerInfo.observer;\n    }\n    if (observer) {\n        return observer;\n    }\n    observer = {};\n    mirror.value = helpers_1._deepClone(obj);\n    var fastCheck;\n    if (callback) {\n        observer.callback = callback;\n        observer.next = null;\n        var dirtyCheck_1 = function () {\n            generate(observer);\n        };\n        fastCheck = function () {\n            clearTimeout(observer.next);\n            observer.next = setTimeout(dirtyCheck_1);\n        };\n        if (typeof window !== 'undefined') { //not Node\n            if (window.addEventListener) { //standards\n                window.addEventListener('mouseup', fastCheck);\n                window.addEventListener('keyup', fastCheck);\n                window.addEventListener('mousedown', fastCheck);\n                window.addEventListener('keydown', fastCheck);\n                window.addEventListener('change', fastCheck);\n            }\n            else { //IE8\n                document.documentElement.attachEvent('onmouseup', fastCheck);\n                document.documentElement.attachEvent('onkeyup', fastCheck);\n                document.documentElement.attachEvent('onmousedown', fastCheck);\n                document.documentElement.attachEvent('onkeydown', fastCheck);\n                document.documentElement.attachEvent('onchange', fastCheck);\n            }\n        }\n    }\n    observer.patches = patches;\n    observer.object = obj;\n    observer.unobserve = function () {\n        generate(observer);\n        clearTimeout(observer.next);\n        removeObserverFromMirror(mirror, observer);\n        if (typeof window !== 'undefined') {\n            if (window.removeEventListener) {\n                window.removeEventListener('mouseup', fastCheck);\n                window.removeEventListener('keyup', fastCheck);\n                window.removeEventListener('mousedown', fastCheck);\n                window.removeEventListener('keydown', fastCheck);\n            }\n            else {\n                document.documentElement.detachEvent('onmouseup', fastCheck);\n                document.documentElement.detachEvent('onkeyup', fastCheck);\n                document.documentElement.detachEvent('onmousedown', fastCheck);\n                document.documentElement.detachEvent('onkeydown', fastCheck);\n            }\n        }\n    };\n    mirror.observers.set(callback, new ObserverInfo(callback, observer));\n    return observer;\n}\nexports.observe = observe;\n/**\n * Generate an array of patches from an observer\n */\nfunction generate(observer) {\n    var mirror = beforeDict.get(observer.object);\n    _generate(mirror.value, observer.object, observer.patches, \"\");\n    if (observer.patches.length) {\n        core_1.applyPatch(mirror.value, observer.patches);\n    }\n    var temp = observer.patches;\n    if (temp.length > 0) {\n        observer.patches = [];\n        if (observer.callback) {\n            observer.callback(temp);\n        }\n    }\n    return temp;\n}\nexports.generate = generate;\n// Dirty check if obj is different from mirror, generate patches and update mirror\nfunction _generate(mirror, obj, patches, path) {\n    if (obj === mirror) {\n        return;\n    }\n    if (typeof obj.toJSON === \"function\") {\n        obj = obj.toJSON();\n    }\n    var newKeys = helpers_1._objectKeys(obj);\n    var oldKeys = helpers_1._objectKeys(mirror);\n    var changed = false;\n    var deleted = false;\n    //if ever \"move\" operation is implemented here, make sure this test runs OK: \"should not generate the same patch twice (move)\"\n    for (var t = oldKeys.length - 1; t >= 0; t--) {\n        var key = oldKeys[t];\n        var oldVal = mirror[key];\n        if (helpers_1.hasOwnProperty(obj, key) && !(obj[key] === undefined && oldVal !== undefined && Array.isArray(obj) === false)) {\n            var newVal = obj[key];\n            if (typeof oldVal == \"object\" && oldVal != null && typeof newVal == \"object\" && newVal != null) {\n                _generate(oldVal, newVal, patches, path + \"/\" + helpers_1.escapePathComponent(key));\n            }\n            else {\n                if (oldVal !== newVal) {\n                    changed = true;\n                    patches.push({ op: \"replace\", path: path + \"/\" + helpers_1.escapePathComponent(key), value: helpers_1._deepClone(newVal) });\n                }\n            }\n        }\n        else if (Array.isArray(mirror) === Array.isArray(obj)) {\n            patches.push({ op: \"remove\", path: path + \"/\" + helpers_1.escapePathComponent(key) });\n            deleted = true; // property has been deleted\n        }\n        else {\n            patches.push({ op: \"replace\", path: path, value: obj });\n            changed = true;\n        }\n    }\n    if (!deleted && newKeys.length == oldKeys.length) {\n        return;\n    }\n    for (var t = 0; t < newKeys.length; t++) {\n        var key = newKeys[t];\n        if (!helpers_1.hasOwnProperty(mirror, key) && obj[key] !== undefined) {\n            patches.push({ op: \"add\", path: path + \"/\" + helpers_1.escapePathComponent(key), value: helpers_1._deepClone(obj[key]) });\n        }\n    }\n}\n/**\n * Create an array of patches from the differences in two objects\n */\nfunction compare(tree1, tree2) {\n    var patches = [];\n    _generate(tree1, tree2, patches, '');\n    return patches;\n}\nexports.compare = compare;\n"],"names":["Object","defineProperty","exports","value","helpers_1","require","core_1","core_2","applyOperation","applyPatch","applyReducer","getValueByPointer","validate","validator","helpers_2","JsonPatchError","PatchError","deepClone","_deepClone","escapePathComponent","unescapePathComponent","beforeDict","WeakMap","Mirror","obj","observers","Map","ObserverInfo","callback","observer","generate","mirror","get","object","_generate","patches","length","temp","path","toJSON","newKeys","_objectKeys","oldKeys","deleted","t","oldVal","key","hasOwnProperty","undefined","Array","isArray","push","op","newVal","unobserve","root","observe","fastCheck","getMirror","observerInfo","getObserverFromMirror","set","next","dirtyCheck_1","clearTimeout","setTimeout","window","addEventListener","document","documentElement","attachEvent","delete","removeObserverFromMirror","removeEventListener","detachEvent","compare","tree1","tree2"],"mappings":"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"}